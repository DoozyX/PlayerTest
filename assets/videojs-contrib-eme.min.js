/*! @name videojs-contrib-eme @version 5.0.0 @license Apache-2.0 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("video.js")):"function"==typeof define&&define.amd?define(["exports","video.js"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).videojsContribEme={},e.videojs)}(this,(function(e,t){"use strict";function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=s(t);function i(){return i=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(e[n]=s[n])}return e},i.apply(this,arguments)}const r=(e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;const s=new DataView(e),n=new DataView(t);for(let e=0;e<s.byteLength;e++)if(s.getUint8(e)!==n.getUint8(e))return!1;return!0},a=e=>e instanceof Uint8Array||e instanceof Uint16Array?e.buffer:e,o=(...e)=>{const t=n.default.mergeOptions(...e);return Object.keys(t).forEach((e=>{null===t[e]&&delete t[e]})),t};let d=n.default.xhr.httpHandler;d||(d=(e,t)=>(s,n,i)=>{if(s)e(s);else{if(n.statusCode>=400&&n.statusCode<=599){let s=i;return t&&(s=String.fromCharCode.apply(null,new Uint8Array(i))),void e({cause:s})}e(null,i)}});const c=(e,t,s,i)=>{const r=(e=>{const t=String.fromCharCode.apply(null,new Uint16Array(e)),s=(new window.DOMParser).parseFromString(t,"application/xml"),n=s.getElementsByTagName("HttpHeaders")[0],i={};if(n){const e=n.getElementsByTagName("name"),t=n.getElementsByTagName("value");for(let s=0;s<e.length;s++)i[e[s].childNodes[0].nodeValue]=t[s].childNodes[0].nodeValue}const r=s.getElementsByTagName("Challenge")[0];let a;return r&&(a=window.atob(r.childNodes[0].nodeValue)),{headers:i,message:a}})(t),a=r.message,c=o(r.headers,s.emeHeaders,e.licenseHeaders);n.default.xhr({uri:e.url,method:"post",headers:c,body:a,responseType:"arraybuffer"},d(i,!0))},y="com.apple.fps.1_0",u=({initData:e,id:t,cert:s})=>{"string"==typeof t&&(t=(e=>{const t=new ArrayBuffer(2*e.length),s=new Uint16Array(t);for(let t=0;t<e.length;t++)s[t]=e.charCodeAt(t);return s})(t));let n=0;const i=new ArrayBuffer(e.byteLength+4+t.byteLength+4+s.byteLength),r=new DataView(i);new Uint8Array(i,n,e.byteLength).set(e),n+=e.byteLength,r.setUint32(n,t.byteLength,!0),n+=4;const a=new Uint16Array(i,n,t.length);a.set(t),n+=a.byteLength,r.setUint32(n,s.byteLength,!0),n+=4;return new Uint8Array(i,n,s.byteLength).set(s),new Uint8Array(i,0,i.byteLength)},l=e=>(t,s)=>{const i=o(t.emeHeaders,e.certificateHeaders);n.default.xhr({uri:e.certificateUri,responseType:"arraybuffer",headers:i},d(((e,t)=>{e?s(e):s(null,new Uint8Array(t))})))},m=(e,t)=>(e=>{const t=document.createElement("a");return t.href=e,t.hostname})(t),g=e=>(t,s,i,r)=>{const a=o({"Content-type":"application/octet-stream"},t.emeHeaders,e.licenseHeaders);n.default.xhr({uri:e.licenseUri,method:"POST",responseType:"arraybuffer",body:i,headers:a},d(r,!0))},f=({video:e,initData:t,options:s,eventBus:n})=>{const i=s.keySystems[y],r=i.getCertificate||l(i),a=i.getContentId||m,o=i.getLicense||g(i);return new Promise(((e,t)=>{r(s,((s,n)=>{s?t(s):e(n)}))})).then((i=>{return(({video:e,contentId:t,initData:s,cert:n,options:i,getLicense:r,eventBus:a})=>new Promise(((o,d)=>{if(!e.webkitKeys)try{e.webkitSetMediaKeys(new window.WebKitMediaKeys(y))}catch(e){return void d("Could not create MediaKeys")}let c;try{c=e.webkitKeys.createSession("video/mp4",u({id:t,initData:s,cert:n}))}catch(e){return void d("Could not create key session")}a.trigger("keysessioncreated"),c.contentId=t,c.addEventListener("webkitkeymessage",(e=>{r(i,t,e.message,((e,t)=>{a&&a.trigger("licenserequestattempted"),e?d(e):c.update(new Uint8Array(t))}))})),c.addEventListener("webkitkeyadded",(()=>{o()})),c.addEventListener("webkitkeyerror",(()=>{const e=c.error;d(`KeySession error: code ${e.code}, systemCode ${e.systemCode}`)}))})))({video:e,cert:i,initData:t,getLicense:o,options:s,contentId:a(s,(r=t,String.fromCharCode.apply(null,new Uint16Array(r.buffer||r)))),eventBus:n});var r}))},p=e=>e.startsWith("com.apple.fps"),h=e=>{let t;return Object.keys(e).forEach((s=>{const n=((e,t)=>{if(t.supportedConfigurations)return t.supportedConfigurations;const s=p(e),n={},r=t.initDataTypes||(s?["sinf"]:null),a=t.audioContentType,o=t.audioRobustness,d=t.videoContentType||(s?"video/mp4":null),c=t.videoRobustness,y=t.persistentState;return(a||o)&&(n.audioCapabilities=[i({},a?{contentType:a}:{},o?{robustness:o}:{})]),(d||c)&&(n.videoCapabilities=[i({},d?{contentType:d}:{},c?{robustness:c}:{})]),y&&(n.persistentState=y),r&&(n.initDataTypes=r),[n]})(s,e[s]);t=t?t.catch((e=>window.navigator.requestMediaKeySystemAccess(s,n))):window.navigator.requestMediaKeySystemAccess(s,n)})),t},k=e=>{const{mediaKeys:t,initDataType:s,initData:i,options:r,getLicense:a,removeSession:o,eventBus:d,contentId:c}=e,y=t.createSession();return d.trigger("keysessioncreated"),new Promise(((t,u)=>{y.addEventListener("message",(e=>{"license-request"!==e.messageType&&"license-renewal"!==e.messageType||a(r,e.message,c).then((e=>{t(y.update(e))})).catch((e=>{u(e)}))}),!1),y.addEventListener("keystatuseschange",(t=>{let s=!1;y.keyStatuses.forEach(((e,i)=>{switch(d.trigger({keyId:i,status:e,target:y,type:"keystatuschange"}),e){case"expired":s=!0;break;case"internal-error":const e='Key status reported as "internal-error." Leaving the session open since we don\'t have enough details to know if this error is fatal.';n.default.log.warn(e,t)}})),s&&y.close().then((()=>{o(i),k(e)}))}),!1),y.generateRequest(s,i).catch((()=>{u("Unable to create or initialize key session")}))}))},v=(e,t)=>{if("string"==typeof t&&(t={url:t}),!t.url&&t.licenseUri&&(t.url=t.licenseUri),!t.url&&!t.getLicense)throw new Error(`Missing url/licenseUri or getLicense in ${e} keySystem configuration.`);const s=p(e);if(s&&t.certificateUri&&!t.getCertificate&&(t.getCertificate=l(t)),s&&!t.getCertificate)throw new Error(`Missing getCertificate or certificateUri in ${e} keySystem configuration.`);return s&&!t.getContentId&&(t.getContentId=m),t.url&&!t.getLicense&&(t.getLicense="com.microsoft.playready"===e?(e=>(t,s,n)=>{c(e,s,t,n)})(t):s?g(t):(e=>(t,s,i)=>{const r=o({"Content-type":"application/octet-stream"},t.emeHeaders,e.licenseHeaders);n.default.xhr({uri:e.url,method:"POST",responseType:"arraybuffer",body:s,headers:r},d(i,!0))})(t)),t},w=({video:e,initDataType:t,initData:s,keySystemAccess:n,options:i,removeSession:r,eventBus:a})=>{let o=Promise.resolve();const d=n.keySystem;let c;try{c=v(d,i.keySystems[d])}catch(e){return Promise.reject(e)}const y=c.getContentId?c.getContentId(i,(u=s,String.fromCharCode.apply(null,new Uint8Array(u.buffer||u)))):null;var u;if(void 0===e.mediaKeysObject){let t;e.mediaKeysObject=null,e.pendingSessionData=[],o=new Promise(((s,r)=>{e.keySystem=d,c.getCertificate?c.getCertificate(i,((e,n)=>{e?r(e):(t=n,s())})):s(n)})).then((()=>n.createMediaKeys())).then((s=>(({video:e,certificate:t,createdMediaKeys:s})=>{e.mediaKeysObject=s;const n=[];t&&n.push(s.setServerCertificate(t));for(let t=0;t<e.pendingSessionData.length;t++){const s=e.pendingSessionData[t];n.push(k({mediaKeys:e.mediaKeysObject,initDataType:s.initDataType,initData:s.initData,options:s.options,getLicense:s.getLicense,removeSession:s.removeSession,eventBus:s.eventBus,contentId:s.contentId}))}return e.pendingSessionData=[],n.push(e.setMediaKeys(s)),Promise.all(n)})({video:e,certificate:t,createdMediaKeys:s}))).catch((e=>e?Promise.reject(e):Promise.reject("Failed to create and initialize a MediaKeys object")))}return o.then((()=>{const n=e.keySystem?((e,t,s)=>(n,i,r)=>new Promise(((a,o)=>{const d=function(e,t){s&&s.trigger("licenserequestattempted"),e?o(e):a(t)};p(e)?t(n,r,new Uint8Array(i),d):t(n,i,d)})))(d,c.getLicense,a):null;return(({video:e,initDataType:t,initData:s,options:n,getLicense:i,contentId:r,removeSession:a,eventBus:o})=>{const d={initDataType:t,initData:s,options:n,getLicense:i,removeSession:a,eventBus:o,contentId:r};return e.mediaKeysObject?(d.mediaKeys=e.mediaKeysObject,k(d)):(e.pendingSessionData.push(d),Promise.resolve())})({video:e,initDataType:t,initData:s,options:i,getLicense:n,contentId:y,removeSession:r,eventBus:a})}))},b="com.microsoft.playready",S=(e,t,s,n)=>{const i=e.msKeys.createSession("video/mp4",t);if(!i)throw new Error("Could not create key session.");n.trigger("keysessioncreated"),i.addEventListener("mskeymessage",(e=>{((e,t,s,n)=>{let i=e.keySystems[b];if("function"==typeof i.getKey)return void i.getKey(e,s.destinationURL,s.message.buffer,((e,s)=>{e?n.trigger({message:"Unable to get key: "+e,target:t,type:"mskeyerror"}):t.update(s)}));"string"==typeof i?i={url:i}:"boolean"==typeof i&&(i={}),i.url||(i.url=s.destinationURL);const r=(e,s)=>{n&&n.trigger("licenserequestattempted"),e?n.trigger({message:"Unable to request key from url: "+i.url,target:t,type:"mskeyerror"}):t.update(new Uint8Array(s))};i.getLicense?i.getLicense(e,s.message.buffer,r):c(i,s.message.buffer,e,r)})(s,i,e,n)})),i.addEventListener("mskeyerror",(e=>{n.trigger({message:`Unexpected key error from key session with code: ${i.error.code} and systemCode: ${i.error.systemCode}`,target:i,type:"mskeyerror"})})),i.addEventListener("mskeyadded",(()=>{n.trigger({target:i,type:"mskeyadded"})}))};const D=(e,t)=>{for(let s=0;s<e.length;s++){if(!e[s].initData)continue;const n=a(e[s].initData),i=a(t);if(r(n,i))return!0}return!1},L=(e,t)=>{for(let s=0;s<e.length;s++)if(e[s].initData===t)return void e.splice(s,1)},C=(e,t,s,n)=>{if(!t||!t.keySystems)return Promise.resolve();let i=e.initData;return h(t.keySystems).then((r=>{const a=r.keySystem;return t.keySystems[a]&&t.keySystems[a].pssh&&(i=t.keySystems[a].pssh),D(s,i)||!i?Promise.resolve():(s.push({initData:i}),w({video:e.target,initDataType:e.initDataType,initData:i,keySystemAccess:r,options:t,removeSession:L.bind(null,s),eventBus:n}))}))},K=(e,t,s)=>t.keySystems&&t.keySystems[y]&&e.initData?f({video:e.target,initData:e.initData,options:t,eventBus:s}):Promise.resolve(),E=(e,t,s,n)=>{if(!t.keySystems||!t.keySystems[b])return;if(s.reduce(((e,t)=>e||t.playready),!1))return;let i=e.initData;t.keySystems[b]&&t.keySystems[b].pssh&&(i=t.keySystems[b].pssh),i&&(s.push({playready:!0,initData:i}),(({video:e,initData:t,options:s,eventBus:n})=>{e.msKeys&&delete e.msKeys;try{e.msSetMediaKeys(new window.MSMediaKeys(b))}catch(e){throw new Error("Unable to create media keys for PlayReady key system. Error: "+e.message)}S(e,t,s,n)})({video:e.target,initData:i,options:t,eventBus:n}))},T=e=>n.default.mergeOptions(e.currentSource(),e.eme.options),U=e=>{const t=e.src();t!==e.eme.activeSrc&&(e.eme.activeSrc=t,e.eme.sessions=[])},_=e=>t=>{const s={code:5};"string"==typeof t?s.message=t:t&&(t.message&&(s.message=t.message),t.cause&&(t.cause.length||t.cause.byteLength)&&(s.cause=t.cause)),e.error(s)},M=function(e={}){const t=this,s=_(t);t.ready((()=>((e,t)=>{if("video"===e.$(".vjs-tech").tagName.toLowerCase())if(U(e),window.MediaKeys)e.tech_.el_.addEventListener("encrypted",(s=>{U(e),C(s,T(e),e.eme.sessions,e.tech_).catch(t)}));else if(window.WebKitMediaKeys){const s=s=>{U(e),K(s,T(e),e.tech_).catch(t)};e.tech_.el_.addEventListener("webkitneedkey",(t=>{const n=T(e).firstWebkitneedkeyTimeout||1e3,i=e.src();e.eme.webkitneedkey_=e.eme.webkitneedkey_||{},e.eme.webkitneedkey_.src!==i&&(e.eme.webkitneedkey_={handledFirstEvent:!1,src:i}),e.eme.webkitneedkey_.handledFirstEvent?s(t):(e.clearTimeout(e.eme.webkitneedkey_.timeout),e.eme.webkitneedkey_.timeout=e.setTimeout((()=>{e.eme.webkitneedkey_.handledFirstEvent=!0,e.eme.webkitneedkey_.timeout=null,s(t)}),n))}))}else window.MSMediaKeys&&(e.tech_.el_.addEventListener("msneedkey",(s=>{U(e);try{E(s,T(e),e.eme.sessions,e.tech_)}catch(e){t(e)}})),e.tech_.on("mskeyerror",t),e.on("dispose",(()=>{e.tech_.off("mskeyerror",t)})))})(t,s))),t.eme={initializeMediaKeys(i={},r=function(){},a=!1){const o=n.default.mergeOptions(t.currentSource(),e,i),d={initDataType:"cenc",initData:null,target:t.tech_.el_};if(U(t),window.MediaKeys)C(d,o,t.eme.sessions,t.tech_).then((()=>r())).catch((e=>{r(e),a||s(e)}));else if(window.MSMediaKeys){const e=n=>{t.tech_.off("mskeyadded",e),t.tech_.off("mskeyerror",e),"mskeyerror"===n.type?(r(n.target.error),a||s(n.message)):r()};t.tech_.one("mskeyadded",e),t.tech_.one("mskeyerror",e);try{E(d,o,t.eme.sessions,t.tech_)}catch(n){t.tech_.off("mskeyadded",e),t.tech_.off("mskeyerror",e),r(n),a||s(n)}}},options:e}};(n.default.registerPlugin||n.default.plugin)("eme",M),M.VERSION="5.0.0",e.default=M,e.emeErrorHandler=_,e.getOptions=T,e.handleEncryptedEvent=C,e.handleMsNeedKeyEvent=E,e.handleWebKitNeedKeyEvent=K,e.hasSession=D,e.removeSession=L,e.setupSessions=U,Object.defineProperty(e,"__esModule",{value:!0})}));